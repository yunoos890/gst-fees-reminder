
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GST Fees Reminder - JB Traders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#4f46e5" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Basic Styles (no external CSS needed) -->
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: linear-gradient(90deg,#4f46e5,#5729a7);
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 1.2rem; }
    header small { display: block; font-size: 0.75rem; opacity: 0.9; }
    main {
      max-width: 1100px;
      margin: 1.5rem auto 2rem;
      padding: 0 1rem;
    }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 1rem;
      padding: 1.2rem 1.4rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      border: 1px solid rgba(148,163,184,0.3);
      margin-bottom: 1.2rem;
    }
    .card h2 {
      margin: 0 0 .5rem;
      font-size: 1rem;
      color: #f9fafb;
    }
    .muted {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .row > * {
      flex: 1 1 180px;
    }
    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: .75rem;
    }
    .metric-pill {
      flex: 1 1 150px;
      padding: .4rem .6rem;
      border-radius: 999px;
      font-size: .8rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric-pill span:first-child {
      color: #9ca3af;
    }
    .metric-pill strong {
      color: #e5e7eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .75rem;
      font-size: .85rem;
    }
    thead {
      background: rgba(15,23,42,0.9);
    }
    th, td {
      padding: .55rem .5rem;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
    }
    th {
      font-weight: 600;
      color: #9ca3af;
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    tr:hover td {
      background: rgba(15,23,42,0.85);
    }
    input, select {
      width: 100%;
      padding: .45rem .5rem;
      border-radius: .5rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: #e5e7eb;
      font-size: .85rem;
    }
    input:focus, select:focus {
      outline: 2px solid #6366f1;
      outline-offset: 0;
    }
    button {
      border-radius: .5rem;
      border: none;
      padding: .35rem .6rem;
      font-size: .8rem;
      cursor: pointer;
      background: #4f46e5;
      color: #e5e7eb;
      white-space: nowrap;
    }
    button:hover { filter: brightness(1.06); }
    button.sms { background: #0891b2; }
    button.upi { background: #16a34a; }
    button.small { font-size: .75rem; padding: .25rem .5rem; }
    button.ghost { background: transparent; border: 1px solid rgba(148,163,184,0.55); color: #e5e7eb; }
    button.red { background: #b91c1c; }
    button.green { background: #15803d; }
    header button {
      background: rgba(15,23,42,0.15);
      border-radius: 999px;
      padding: .35rem .9rem;
      font-size: .8rem;
      border: 1px solid rgba(209,213,219,0.4);
    }
    .pill {
      padding: .15rem .5rem;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 600;
    }
    .pill.due { background: rgba(234,179,8,0.12); color: #facc15; }
    .pill.overdue { background: rgba(220,38,38,0.18); color: #fca5a5; }
    .pill.paid { background: rgba(22,163,74,0.20); color: #bbf7d0; }
    .actions button { margin: 0 .15rem .2rem 0; }
    #success {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22,163,74,0.95);
      color: #ecfdf5;
      padding: .5rem 1rem;
      border-radius: 999px;
      font-size: .8rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      z-index: 40;
    }
    .hidden { display: none !important; }
    .qr-preview-wrapper {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: .5rem;
    }
    #qrPlaceholder {
      width: 120px;
      height: 120px;
      border-radius: .75rem;
      border: 1px dashed rgba(148,163,184,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
      color: #9ca3af;
      background: rgba(15,23,42,0.9);
    }
    #staticQr {
      width: 120px;
      height: 120px;
      border-radius: .75rem;
      display: none;
      border: 1px solid rgba(148,163,184,0.4);
    }
    #dueChart {
      max-width: 260px;
      max-height: 260px;
      margin: 0 auto;
    }
    .split {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 1.1rem;
    }
    @media (max-width: 900px) {
      .split { grid-template-columns: 1fr; }
    }
    /* Auth overlay */
    #authOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(59,130,246,0.2), transparent 55%),
                  radial-gradient(circle at bottom, rgba(56,189,248,0.15), #020617 70%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #authOverlayInner {
      background: rgba(15,23,42,0.96);
      border-radius: 1.25rem;
      padding: 1.5rem 1.7rem;
      width: min(360px, 92vw);
      border: 1px solid rgba(148,163,184,0.55);
      box-shadow: 0 25px 50px rgba(0,0,0,0.8);
    }
    #authOverlayInner h2 {
      margin-top: 0;
      margin-bottom: 0.25rem;
      font-size: 1.05rem;
    }
    #authOverlayInner p {
      margin-top: 0;
      font-size: .83rem;
      color: #9ca3af;
    }
    #authOverlayInner .btn-row {
      display: flex;
      gap: .5rem;
      margin-top: .75rem;
      justify-content: flex-end;
    }
    #authOverlayInner label {
      display: block;
      font-size: .8rem;
      margin: .6rem 0 .2rem;
      color: #e5e7eb;
    }
    #authOverlayInner input {
      width: 100%;
    }
    #forgotBtn {
      background: transparent;
      border: none;
      color: #9ca3af;
      text-decoration: underline;
      font-size: .75rem;
      padding: 0;
    }
    /* QR overlay */
    #qrOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    #qrModal {
      background: #020617;
      border-radius: 1.25rem;
      padding: 1rem 1.2rem 1.3rem;
      width: min(380px, 94vw);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 25px 50px rgba(0,0,0,0.9);
      text-align: center;
    }
    #qrCanvas canvas, #qrCanvas img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    #qrModal h3 {
      margin: .3rem 0 .1rem;
      font-size: 1rem;
    }
    #qrModal p {
      margin: 0;
      font-size: .85rem;
      color: #9ca3af;
    }
    #qrModal .btn-row {
      margin-top: .85rem;
      display: flex;
      justify-content: space-between;
      gap: .5rem;
    }
    #qrModal button {
      flex: 1;
    }
    /* Bulk Message Template overlay */
    #bulkMessageOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 70;
    }
    #bulkMessageModal {
      background: #020617;
      border-radius: 1.25rem;
      padding: 1.2rem 1.5rem 1.5rem;
      width: min(600px, 95vw);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 25px 50px rgba(0,0,0,0.9);
      max-height: 90vh;
      overflow-y: auto;
    }
    #bulkMessageTemplate {
      border-radius: 0.5rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: #e5e7eb;
      padding: 0.5rem;
      font-size: 0.85rem;
      font-family: inherit;
      resize: vertical;
    }

    /* Important Note overlay (per-client, typing-only) */
    #importantNoteOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
    }
    #importantNoteInner {
      background: #020617;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      width: min(720px, 96vw);
      border: 1px solid rgba(148,163,184,0.55);
      box-shadow: 0 20px 40px rgba(0,0,0,0.7);
    }
    #importantNoteInner h3 { margin: 0 0 .25rem; font-size: 1rem; }
    #importantNoteInner .muted { font-size: .85rem; color: #9ca3af; margin-bottom:.6rem; }
    #importantNoteTextarea {
      width: 100%;
      min-height: 160px;
      padding: .6rem;
      border-radius: .5rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      font-size: .95rem;
    }
    #importantNoteMeta { font-size: .85rem; color: #9ca3af; margin-top:.45rem; }
    #importantNoteInner .btn-row { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.6rem; }
    #importantNoteInner button { padding:.45rem .7rem; font-size:.9rem; }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
</head>
<body>
  <div id="authOverlay">
    <div id="authOverlayInner">
      <h2>Secure GST Fees App</h2>
      <p id="authMessage">Loadingâ€¦</p>

      <!-- First-time setup -->
      <div id="authSetup" style="display:none;">
        <label for="newPass">New Password</label>
        <input type="password" id="newPass" autocomplete="new-password">
        <label for="confirmPass">Confirm Password</label>
        <input type="password" id="confirmPass" autocomplete="new-password">
        <div class="btn-row">
          <button id="setPassBtn">Save Password</button>
        </div>
      </div>

      <!-- Login -->
      <div id="authLogin" style="display:none;">
        <label for="loginPass">Password</label>
        <input type="password" id="loginPass" autocomplete="current-password">
        <div class="btn-row">
          <button id="loginBtn">Unlock</button>
        </div>
        <div style="margin-top:.5rem; text-align:right;">
          <button id="forgotBtn" type="button">Forgot password?</button>
        </div>
      </div>
    </div>
  </div>

  <div id="qrOverlay" class="hidden">
    <div id="qrModal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:.8rem; color:#9ca3af;">UPI Payment QR</span>
        <button id="closeModal" class="ghost small" type="button">Close</button>
      </div>
      <h3 id="clientNameDisplay">Client</h3>
      <p id="qrAmount">â‚¹0</p>
      <div id="qrCanvas" style="margin-top:.5rem;"></div>
      <div class="btn-row">
        <button id="directPayBtn" class="upi">Pay with UPI App</button>
      </div>
    </div>
  </div>

  <!-- Bulk Message Template Modal -->
  <div id="bulkMessageOverlay" class="hidden">
    <div id="bulkMessageModal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:.8rem; color:#9ca3af;">Bulk Message Template</span>
        <button id="closeBulkMessageModal" class="ghost small" type="button">Close</button>
      </div>
      <h3>Send Same Message to All Unpaid Clients</h3>
      <p class="muted" style="margin-bottom:1rem;">Type your message once and it will be sent to all unpaid clients with their specific details automatically inserted.</p>

      <div style="margin-bottom:1rem;">
        <label class="muted" for="bulkMessageTemplate">Message Template</label>
        <textarea id="bulkMessageTemplate" rows="12" style="width:100%; resize:vertical; margin-top:.25rem;" placeholder="Type your message here...">Dear {name},

GST Returns Pending Fees of Rs. {amount}.00 is payable for the period {period}.

Pay using UPI:
{upi}

Thank you,
J. Bilal & Co.
+91 94860 24162</textarea>
        <small class="muted" style="display:block; margin-top:.25rem;">
          Available variables: {name}, {amount}, {period}, {upi}
        </small>
      </div>

      <div id="bulkMessagePreview" style="margin-bottom:1rem; display:none;">
        <h4 style="margin:0 0 .5rem; color:#e5e7eb;">Preview (First Client)</h4>
        <div id="previewContent" style="background:rgba(15,23,42,0.8); padding:1rem; border-radius:.5rem; border:1px solid rgba(148,163,184,0.3); font-size:.85rem; white-space:pre-wrap;"></div>
      </div>

      <div class="btn-row">
        <button id="previewBulkMessage" class="ghost">Preview Message</button>
        <button id="sendBulkMessageWhatsApp" class="sms">Send via WhatsApp</button>
        <button id="sendBulkMessageSMS" class="small">Send via SMS</button>
      </div>
    </div>
  </div>

  <!-- Important Note Modal (per-client, typing-only, not for sending) -->
  <div id="importantNoteOverlay">
    <div id="importantNoteInner">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
        <div>
          <h3 id="importantNoteClientName">Client</h3>
          <div class="muted" id="importantNoteClientPeriod">Period</div>
        </div>
        <div style="display:flex; gap:0.5rem;">
          <button id="clearImportantNoteBtn" class="ghost small" type="button">Clear</button>
          <button id="closeImportantNoteBtn" class="ghost small" type="button">Close</button>
        </div>
      </div>

      <label class="muted" for="importantNoteTextarea">Important Note (saved locally per client)</label>
      <textarea id="importantNoteTextarea" rows="8" placeholder="Type important notes for this client. This will be saved locally only and will not be sent anywhere."></textarea>
      <div id="importantNoteMeta" class="muted">No saved note yet.</div>

      <div class="btn-row">
        <button id="saveImportantNoteBtn" class="small">Save Note</button>
      </div>
    </div>
  </div>

  <div id="app" style="display:none;">
    <header>
      <div>
        <h1>J. Bilal &amp; Co. â€¢ GST Fees</h1>
        <small>
          <span id="currentDate"></span>
        </small>
      </div>
      <div style="display:flex; gap:.5rem; align-items:center;">
        <button id="lockBtn" type="button">ðŸ”’ Lock</button>
      </div>
    </header>

    <main>
      <!-- Client Portal Card (Feature 7) -->
      <div class="card hidden" id="clientPortalCard">
        <h2>Client GST Payment Portal</h2>
        <p class="muted">View your GST fees and pay directly using UPI.</p>
        <div class="metrics">
          <div class="metric-pill">
            <span>Client</span>
            <strong id="clientPortalName">-</strong>
          </div>
          <div class="metric-pill">
            <span>Amount</span>
            <strong id="clientPortalAmount">â‚¹0</strong>
          </div>
          <div class="metric-pill">
            <span>Period</span>
            <strong id="clientPortalPeriod">-</strong>
          </div>
          <div class="metric-pill">
            <span>Status</span>
            <strong id="clientPortalStatus">-</strong>
          </div>
        </div>
        <div style="margin-top:.9rem; display:flex; gap:.5rem;">
          <button id="clientPortalPayUpi" class="upi">Pay Now via UPI</button>
          <button id="clientPortalWhatsApp" class="sms">Message on WhatsApp</button>
        </div>
      </div>

      <!-- Advanced Reminder Scheduling -->
      <div class="card">
        <h2>Advanced Reminder Scheduling</h2>
        <p class="muted">Automatically send WhatsApp reminders with flexible scheduling options.</p>
        <form id="reminderForm">
          <div class="row">
            <div>
              <label class="muted" for="reminderEnabled">
                <input type="checkbox" id="reminderEnabled"> Enable Automatic Reminders
              </label>
            </div>
          </div>
          <div class="row" style="margin-top:.6rem;">
            <div>
              <label class="muted" for="scheduleType">Schedule Type</label>
              <select id="scheduleType">
                <option value="monthly">Monthly</option>
                <option value="weekly">Weekly</option>
                <option value="biweekly">Bi-weekly</option>
              </select>
            </div>
            <div>
              <label class="muted" for="reminderTime">Time (24-hour format)</label>
              <input id="reminderTime" type="time" value="09:00">
            </div>
          </div>
          <div class="row" id="monthlyOptions" style="margin-top:.6rem;">
            <div>
              <label class="muted" for="reminderDay">Day of Month</label>
              <select id="reminderDay">
                <option value="1">1st</option>
                <option value="5">5th</option>
                <option value="10">10th</option>
                <option value="15">15th</option>
                <option value="20">20th</option>
                <option value="25">25th</option>
                <option value="28">28th</option>
              </select>
            </div>
          </div>
          <div class="row" id="weeklyOptions" style="margin-top:.6rem; display:none;">
            <div>
              <label class="muted" for="reminderDayOfWeek">Day of Week</label>
              <select id="reminderDayOfWeek">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </div>
          </div>
          <div style="margin-top:.8rem;">
            <label class="muted" for="reminderMessage">Message Template</label>
            <textarea id="reminderMessage" rows="8" style="width:100%; resize:vertical; margin-top:.25rem;">Dear {name},

GST Returns Pending Fees of Rs. {amount}.00 is payable for the period {period}.

Pay using UPI:
{upi}

Thank you,
J. Bilal & Co.
+91 94860 24162</textarea>
            <small class="muted" style="display:block; margin-top:.25rem;">
              Available variables: {name}, {amount}, {period}, {upi}
            </small>
          </div>
          <div style="margin-top:.8rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button type="button" id="testReminderBtn" class="ghost small">Test Reminder</button>
            <button type="submit" id="saveReminderBtn">Save Settings</button>
          </div>
        </form>
        <div id="reminderHistory" style="margin-top:1rem; display:none;">
          <h3 style="margin:0 0 .5rem; font-size:1rem;">Recent Reminder History</h3>
          <div id="historyList" style="font-size:.85rem; color:#9ca3af;"></div>
        </div>
      </div>

      <!-- New client form - moved to top -->
      <div class="card">
        <h2 id="newClientHeading">Add / Edit Client</h2>
        <form id="clientForm" autocomplete="off">
          <input type="hidden" id="editingId">
          <div class="row">
            <div>
              <label class="muted" for="clientName">Client Name</label>
              <input id="clientName" required placeholder="ABC Traders">
            </div>
            <div>
              <label class="muted" for="amount">Amount (â‚¹)</label>
              <input id="amount" type="number" step="0.01" required placeholder="600">
            </div>
          </div>
          <div class="row" style="margin-top:.6rem;">
            <div>
              <label class="muted" for="startMonth">From Month</label>
              <input id="startMonth" type="month" required>
            </div>
            <div>
              <label class="muted" for="endMonth">To Month</label>
              <input id="endMonth" type="month" required>
            </div>
            <div>
              <label class="muted" for="phone">Phone (WhatsApp)</label>
              <input id="phone" placeholder="94860xxxxx or +91â€¦">
            </div>
          </div>
          <div style="margin-top:.8rem; display:flex; gap:.5rem; justify-content:flex-end;">
            <button type="button" id="cancelEditBtn" class="ghost" style="display:none;">Cancel Edit</button>
            <button type="submit" id="saveBtn">Save Client</button>
          </div>
        </form>
      </div>

      <!-- Top dashboard: metrics + chart (Feature 4) -->
      <div class="card">
        <h2>Dashboard Summary</h2>
        <p class="muted">Quick view of pending, paid and overdue GST fees.</p>
        <div class="split">
          <div>
            <div class="metrics">
              <div class="metric-pill">
                <span>Total Clients</span>
                <strong id="totalCount">0</strong>
              </div>
              <div class="metric-pill">
                <span>Pending Clients</span>
                <strong id="dueCount">0</strong>
              </div>
              <div class="metric-pill">
                <span>Total Due</span>
                <strong id="totalDue">â‚¹0</strong>
              </div>
            </div>
            <div class="metrics" style="margin-top:.7rem;">
              <div class="metric-pill">
                <span>This Month Billed</span>
                <strong id="thisMonthBilled">â‚¹0</strong>
              </div>
              <div class="metric-pill">
                <span>This Month Collected</span>
                <strong id="thisMonthPaid">â‚¹0</strong>
              </div>
              <div class="metric-pill">
                <span>Overdue Count</span>
                <strong id="overdueCount">0</strong>
              </div>
            </div>
          </div>
          <div>
            <canvas id="dueChart" aria-label="Due vs Paid chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Search + broadcast + export/backup -->
      <div class="card">
        <h2>Clients &amp; Fees</h2>
        <div class="row" style="margin-top:.25rem;">
          <div>
            <input type="search" id="search" placeholder="Search client by nameâ€¦">
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end;">
            <button id="messageAllBtn" class="sms small" type="button">Broadcast WhatsApp (Unpaid)</button>
            <button id="smsAllBtn" class="small" type="button">Broadcast SMS (Unpaid)</button>
          </div>
        </div>
        <div style="margin-top:.5rem; display:flex; gap:.5rem; justify-content:flex-end; flex-wrap:wrap;">
          <button id="exportBtn" class="ghost small">Export CSV</button>
          <button id="backupJsonBtn" class="ghost small">Download JSON Backup</button>
          <button id="restoreJsonBtn" class="ghost small">Restore from JSON</button>
          <button id="syncCloudBtn" class="ghost small">Sync to Cloud</button>
          <button id="loadCloudBtn" class="ghost small">Load from Cloud</button>
          <button id="bulkMessageBtn" class="small">Bulk Message Template</button>
        </div>

        <table id="table">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll" /></th>
              <th>Client</th>
              <th>Amount</th>
              <th>Period</th>
              <th>Status</th>
              <th>Phone</th>
              <th>Reminder Frequency</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- rows via JS -->
          </tbody>
        </table>
        <div style="margin-top:.5rem; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.5rem;">
          <button id="bulkPaidBtn" class="green small" style="display:none;">Mark Selected as Paid</button>
        </div>
      </div>

      <!-- Static QR + UPI details -->
      <div class="card">
        <h2>Static UPI QR &amp; Bank Details</h2>
        <p class="muted">Use this section to maintain your generic UPI QR for walk-in clients and to copy account details quickly.</p>

        <div class="split">
          <div>
            <div class="qr-preview-wrapper">
              <div id="qrPlaceholder">No QR uploaded</div>
              <img id="staticQr" alt="Static UPI QR">
            </div>
            <div style="margin-top:.5rem; display:flex; flex-wrap:wrap; gap:.5rem;">
              <button id="uploadQrBtn" class="small">Upload QR Image</button>
              <input type="file" id="qrUpload" accept="image/*" class="hidden">
              <button id="clearQrBtn" class="ghost small">Remove QR</button>
            </div>
            <div style="margin-top:.75rem;">
              <label class="muted" for="staticAmount">Generate New Static QR</label>
              <div class="row" style="margin-top:.25rem;">
                <div>
                  <input id="staticAmount" type="number" step="0.01" placeholder="Optional amount (â‚¹)">
                </div>
                <div style="display:flex; gap:.4rem; justify-content:flex-end;">
                  <button id="genStaticWithAmt" class="small">QR with Amount</button>
                  <button id="genStaticNoAmt" class="ghost small">QR without Amount</button>
                </div>
              </div>
            </div>
          </div>

          <div>
            <div style="font-size:.9rem;">
              <div><strong>UPI ID:</strong> <span id="upiDisplay"></span></div>
              <div style="margin-top:.15rem;"><strong>Account Holder:</strong> <span id="accountHolder"></span></div>
              <div style="margin-top:.15rem;"><strong>Account No:</strong> <span id="bankAccount"></span></div>
              <div style="margin-top:.15rem;"><strong>IFSC:</strong> <span id="bankIfsc"></span></div>
              <div style="margin-top:.15rem;"><strong>Primary Phone:</strong> <span id="phonePrimary"></span></div>
              <div style="margin-top:.15rem;"><strong>Backup Phone:</strong> <span id="phoneBackup"></span></div>
            </div>
            <div style="margin-top:.7rem; display:flex; gap:.5rem; flex-wrap:wrap;">
              <button id="editUpi" class="small">Edit UPI ID</button>
              <button id="payDirect" class="upi small">Open UPI App (No Amount)</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="success" class="hidden">QR Ready â€¢ Scan & Pay</div>

  <input type="file" id="restoreFileInput" class="hidden" accept="application/json">

  <script>
/* ======= Constants & storage keys ======= */
const DATA = 'gst_clients_2025';
const UPI = 'jbilal_upi_2025';
const BENEFICIARY = 'JB Traders';
const DEFAULT_UPI = '9486681699@axl';
const BANK_ACCOUNT = '918020113127869';
const BANK_IFSC = 'UTIB0002097';
const BANK_ACCOUNT_NAME = 'JB Traders';
const PHONE_PRIMARY = '9486681699';
const PHONE_BACKUP = '9600696599';
const STATIC_QR_KEY = 'gst_static_qr_image';
const MONTHLY_REMINDERS = 'gst_monthly_reminders';
const REMINDER_HISTORY = 'gst_reminder_history';
const CLIENT_REMINDER_SETTINGS = 'gst_client_reminder_settings';

// ===== Cloud Sync Config (Feature 2) =====
const CLOUD_ENDPOINT = ''; // e.g. 'https://your-project-id.firebaseio.com/gst-fees.json'
const CLOUD_AUTH_TOKEN = ''; // optional auth token or API key

// Optional: IMGBB key for desktop automatic upload fallback. Leave empty to skip upload.
const IMGBB_API_KEY = ''; // <- put your imgbb API key here if you want upload fallback

let clients = [];
const urlParams = new URLSearchParams(window.location.search);
const CLIENT_MODE_ID = urlParams.get('client') || null;
const PAY_ID = urlParams.get('pay') || null;

let clockTimer;
let qrInstance = null;
let toastTimer = null;
let searchDebounce = null;
let chartInstance = null;

/* ======= Helpers ======= */
const $ = id => document.getElementById(id);

function ensureUpi() {
  if (!localStorage.getItem(UPI)) localStorage.setItem(UPI, DEFAULT_UPI);
}
function getUpiId() {
  return localStorage.getItem(UPI) || DEFAULT_UPI;
}

function buildUpiIntent(amount = '') {
  const params = new URLSearchParams();
  params.set('pa', getUpiId());
  params.set('pn', BENEFICIARY);
  params.set('cu', 'INR');
  if (amount !== '' && !Number.isNaN(Number(amount)) && Number(amount) > 0) {
    params.set('am', Number(amount).toFixed(2));
  }
  return `upi://pay?${params.toString()}`;
}

function formatMonth(ym) {
  if (!ym) return '';
  try {
    const [y, m] = ym.split('-').map(Number);
    const d = new Date(y, m - 1, 1);
    return d.toLocaleDateString('en-IN', { month: 'short', year: 'numeric' });
  } catch (e) {
    return ym;
  }
}
function formatPeriod(start, end) {
  if (!start && !end) return '';
  if (!start) return formatMonth(end);
  if (!end) return formatMonth(start);
  const s = String(start);
  const e = String(end);
  if (s === e) return formatMonth(s);
  return `${formatMonth(s)} â€” ${formatMonth(e)}`;
}
function currentYmNumber() {
  const now = new Date();
  return now.getFullYear() * 100 + (now.getMonth() + 1);
}
function escapeHtml(s) {
  if (!s) return '';
  return String(s).replace(/[&<>\"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c] || c));
}
function showToast(message = 'QR Ready â€¢ Scan & Pay', duration = 3000) {
  const banner = document.getElementById('success');
  if (!banner) return;
  window.clearTimeout(toastTimer);
  banner.textContent = message;
  banner.classList.remove('hidden');
  toastTimer = setTimeout(() => banner.classList.add('hidden'), duration);
}
function copyText(text) {
  if (!text) return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(
      () => showToast('Copied to clipboard'),
      () => fallbackCopy(text)
    );
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    showToast('Copied to clipboard');
  } catch (e) {
    alert('Copy failed');
  }
  document.body.removeChild(ta);
}

/* ======= Monthly Reminder System ======= */
function getMonthlyReminders() {
  const stored = localStorage.getItem(MONTHLY_REMINDERS);
  return stored ? JSON.parse(stored) : {
    enabled: false,
    scheduleType: 'monthly', // monthly, weekly, biweekly
    dayOfMonth: 1, // 1st of every month
    dayOfWeek: 1, // Monday (0=Sunday, 1=Monday, etc.)
    sendTime: '09:00', // 9 AM
    lastSent: null,
    messageTemplate: `Dear {name},

GST Returns Pending Fees of Rs. {amount}.00 is payable for the period {period}.

Pay using UPI:
{upi}

Thank you,
J. Bilal & Co.
+91 94860 24162`
  };
}

function getClientReminderSettings() {
  const stored = localStorage.getItem(CLIENT_REMINDER_SETTINGS);
  return stored ? JSON.parse(stored) : {};
}

function saveClientReminderSettings(settings) {
  localStorage.setItem(CLIENT_REMINDER_SETTINGS, JSON.stringify(settings));
}

function getClientReminderSetting(clientId) {
  const allSettings = getClientReminderSettings();
  return allSettings[clientId] || {
    frequency: 'monthly', // monthly, weekly, biweekly, custom
    customDays: 30, // days between reminders for custom
    lastReminderSent: null,
    enabled: true
  };
}

function setClientReminderSetting(clientId, settings) {
  const allSettings = getClientReminderSettings();
  allSettings[clientId] = { ...getClientReminderSetting(clientId), ...settings };
  saveClientReminderSettings(allSettings);
}

function saveMonthlyReminders(settings) {
  localStorage.setItem(MONTHLY_REMINDERS, JSON.stringify(settings));
}

function getReminderHistory() {
  const stored = localStorage.getItem(REMINDER_HISTORY);
  return stored ? JSON.parse(stored) : [];
}

function addReminderHistory(entry) {
  const history = getReminderHistory();
  history.unshift({
    timestamp: new Date().toISOString(),
    ...entry
  });
  // Keep only last 100 entries
  if (history.length > 100) history.splice(100);
  localStorage.setItem(REMINDER_HISTORY, JSON.stringify(history));
}

function checkAndSendScheduledReminders() {
  const settings = getMonthlyReminders();
  if (!settings.enabled) return;

  const now = new Date();
  const currentHour = now.getHours();
  const currentMinute = now.getMinutes();

  const [targetHour, targetMinute] = settings.sendTime.split(':').map(Number);

  // Check if it's the right time (within a 5-minute window to account for timer imprecision)
  if (currentHour !== targetHour || Math.abs(currentMinute - targetMinute) > 5) return;

  // Get clients that need reminders based on their individual schedules
  const clientsToRemind = getClientsDueForReminders(settings);
  if (clientsToRemind.length === 0) {
    console.log('No clients due for reminders at this time');
    return;
  }

  console.log(`Sending scheduled reminders to ${clientsToRemind.length} clients`);

  // Send reminders
  sendBulkScheduledReminders(clientsToRemind, settings);

  // Update last sent timestamps for reminded clients
  updateClientReminderTimestamps(clientsToRemind);

  // Refresh history display
  showReminderHistory();
}

function getClientsDueForReminders(globalSettings) {
  const clientsDue = [];

  for (const client of clients) {
    if (client.paid) continue; // Skip paid clients

    const clientSettings = getClientReminderSetting(client.id);
    if (!clientSettings.enabled) continue; // Skip if reminders disabled for this client

    const isDue = isClientDueForReminder(client, clientSettings, globalSettings);
    if (isDue) {
      clientsDue.push(client);
    }
  }

  return clientsDue;
}

function isClientDueForReminder(client, clientSettings, globalSettings) {
  const now = new Date();
  const lastSent = clientSettings.lastReminderSent;

  if (!lastSent) return true; // Never sent before, so due

  const lastSentDate = new Date(lastSent);
  const daysSinceLastReminder = Math.floor((now - lastSentDate) / (1000 * 60 * 60 * 24));

  switch (clientSettings.frequency) {
    case 'weekly':
      return daysSinceLastReminder >= 7;
    case 'biweekly':
      return daysSinceLastReminder >= 14;
    case 'monthly':
      return isMonthlyReminderDue(globalSettings, lastSentDate);
    case 'custom':
      return daysSinceLastReminder >= clientSettings.customDays;
    default:
      return false;
  }
}

function isMonthlyReminderDue(settings, lastSentDate) {
  const now = new Date();

  switch (settings.scheduleType) {
    case 'weekly':
      return (now.getDay() === settings.dayOfWeek &&
              now.getDate() !== lastSentDate.getDate()); // Different day means it's a new week

    case 'biweekly':
      const daysSinceLast = Math.floor((now - lastSentDate) / (1000 * 60 * 60 * 24));
      return (now.getDay() === settings.dayOfWeek && daysSinceLast >= 14);

    case 'monthly':
    default:
      return (now.getDate() === settings.dayOfMonth &&
              now.getDate() !== lastSentDate.getDate()); // Different day means it's a new month
  }
}

function sendBulkScheduledReminders(clientsToRemind, settings) {
  let sentCount = 0;
  const delay = 1000; // 1 second delay between messages

  clientsToRemind.forEach((client, index) => {
    setTimeout(() => {
      const message = buildReminderMessage(client, settings.messageTemplate);
      sendWhatsAppMessage(client, message);
      sentCount++;
      if (sentCount === clientsToRemind.length) {
        addReminderHistory({
          type: 'scheduled',
          clientCount: clientsToRemind.length,
          message: 'Scheduled reminders sent to clients'
        });
        showToast(`Scheduled reminders sent to ${clientsToRemind.length} clients`);
      }
    }, index * delay);
  });
}

function updateClientReminderTimestamps(clientsReminded) {
  const now = new Date();
  clientsReminded.forEach(client => {
    setClientReminderSetting(client.id, {
      lastReminderSent: now.toISOString()
    });
  });
}

function sendBulkMonthlyReminders(clients, settings) {
  let sentCount = 0;
  const delay = 1000; // 1 second delay between messages

  clients.forEach((client, index) => {
    setTimeout(() => {
      const message = buildReminderMessage(client, settings.messageTemplate);
      sendWhatsAppMessage(client, message);
      sentCount++;
      if (sentCount === clients.length) {
        addReminderHistory({
          type: 'monthly',
          clientCount: clients.length,
          message: 'Monthly reminders sent to unpaid clients'
        });
        showToast(`Monthly reminders sent to ${clients.length} clients`);
      }
    }, index * delay);
  });
}

function buildReminderMessage(client, template) {
  const periodText = formatPeriod(client.start, client.end);
  const upiIntent = buildUpiIntent(client.amount);

  return template
    .replace('{name}', client.name)
    .replace('{amount}', Number(client.amount).toLocaleString('en-IN'))
    .replace('{period}', periodText)
    .replace('{upi}', upiIntent);
}

function sendWhatsAppMessage(client, message) {
  const encoded = encodeURIComponent(message);
  const phone = (client.phone || '').replace(/[^0-9+]/g, '').replace(/^0+/, '').replace(/^\+/, '');
  const url = phone
    ? `https://wa.me/${phone}?text=${encoded}`
    : `https://wa.me/?text=${encoded}`;
  window.open(url, '_blank', 'noopener,noreferrer');
}

/* ======= Persistence ======= */
function load() {
  const d = localStorage.getItem(DATA);
  clients = d ? JSON.parse(d) : [];
  ensureUpi();
}
function save() {
  localStorage.setItem(DATA, JSON.stringify(clients));
}

/* ======= Cloud Sync (Feature 2) ======= */
async function syncToCloud() {
  if (!CLOUD_ENDPOINT) {
    showToast('Set CLOUD_ENDPOINT first');
    return;
  }
  const payload = {
    clients,
    upi: getUpiId(),
    updatedAt: new Date().toISOString()
  };
  const url = CLOUD_AUTH_TOKEN
    ? `${CLOUD_ENDPOINT}?auth=${encodeURIComponent(CLOUD_AUTH_TOKEN)}`
    : CLOUD_ENDPOINT;

  try {
    const res = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    showToast('Synced to cloud');
  } catch (e) {
    console.error(e);
    showToast('Cloud sync failed');
  }
}

async function loadFromCloud() {
  if (!CLOUD_ENDPOINT) {
    showToast('Set CLOUD_ENDPOINT first');
    return;
  }
  const url = CLOUD_AUTH_TOKEN
    ? `${CLOUD_ENDPOINT}?auth=${encodeURIComponent(CLOUD_AUTH_TOKEN)}`
    : CLOUD_ENDPOINT;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (!data || !Array.isArray(data.clients)) {
      showToast('No cloud data');
      return;
    }
    clients = data.clients;
    save();
    if (data.upi) localStorage.setItem(UPI, data.upi);
    if (CLIENT_MODE_ID) {
      showClientPortal();
    } else {
      render();
    }
    updateMeta();
    showToast('Loaded from cloud');
  } catch (e) {
    console.error(e);
    showToast('Cloud load failed');
  }
}

/* ======= Static QR preview handling ======= */
function updateStaticQrPreview(src) {
  const img = document.getElementById('staticQr');
  const placeholder = document.getElementById('qrPlaceholder');
  if (!img || !placeholder) return;
  if (src) {
    img.src = src;
    img.style.display = 'block';
    placeholder.style.display = 'none';
    img.alt = 'Static UPI payment QR code';
  } else {
    img.src = '';
    img.style.display = 'none';
    placeholder.style.display = 'block';
  }
}
function loadStaticQr() {
  const stored = localStorage.getItem(STATIC_QR_KEY);
  updateStaticQrPreview(stored);
}

/* ======= Generate & save static QR locally ======= */
async function generateAndSaveStaticQr(upiLink) {
  try {
    const tmp = new QRCodeStyling({
      width: 340,
      height: 340,
      data: upiLink,
      margin: 10,
      dotsOptions: { color: "#8b5cf6", type: "rounded" },
      backgroundOptions: { color: "#ffffff" }
    });
    const wrapper = document.createElement('div');
    wrapper.style.position = 'fixed';
    wrapper.style.left = '-9999px';
    document.body.appendChild(wrapper);
    tmp.append(wrapper);

    const blob = await tmp.getRawData('png');
    const dataUrl = await new Promise((res, rej) => {
      const r = new FileReader();
      r.onloadend = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(blob);
    });

    localStorage.setItem(STATIC_QR_KEY, dataUrl);
    updateStaticQrPreview(dataUrl);
    showToast('Static QR generated & saved');
    document.body.removeChild(wrapper);
    return true;
  } catch (err) {
    console.error('QR generation failed', err);
    alert('QR generation failed: ' + (err && err.message ? err.message : err));
    return false;
  }
}

/* ======= Edit functionality ======= */
function startEdit(id) {
  const client = clients.find(c => c.id === id);
  if (!client) return alert('Client not found');
  document.getElementById('clientName').value = client.name;
  document.getElementById('amount').value = client.amount;
  document.getElementById('startMonth').value = client.start;
  document.getElementById('endMonth').value = client.end;
  document.getElementById('phone').value = client.phone || '';
  document.getElementById('editingId').value = client.id;
  document.getElementById('saveBtn').textContent = 'Update Client';
  document.getElementById('cancelEditBtn').style.display = 'inline-block';
  document.getElementById('clientName').focus();
}
function cancelEdit() {
  document.getElementById('editingId').value = '';
  document.getElementById('clientForm').reset();
  document.getElementById('saveBtn').textContent = 'Save Client';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

/* ======= Status & rendering ======= */
function computeStatus(c) {
  if (c.paid) return 'PAID';
  const now = currentYmNumber();
  const endNum = Number((c.end || '').replace('-', '')) || 0;
  if (endNum === 0) return 'PENDING';
  return (endNum >= now) ? 'PENDING' : 'OVERDUE';
}

function render() {
  const tbody = document.getElementById('table').querySelector('tbody');
  tbody.innerHTML = '';
  const q = (document.getElementById('search').value || '').toLowerCase().trim();

  let pendingAmt = 0, paidAmt = 0, overdueAmt = 0;
  let pendingCount = 0;

  const visibleClients = clients.filter(c => !q || c.name.toLowerCase().includes(q));

  visibleClients.forEach(c => {
    const status = computeStatus(c);
    const amountNum = Number(c.amount || 0);

    if (status === 'PENDING') {
      pendingAmt += amountNum;
      pendingCount++;
    } else if (status === 'PAID') {
      paidAmt += amountNum;
    } else if (status === 'OVERDUE') {
      overdueAmt += amountNum;
    }

    const tr = document.createElement('tr');
    const clientReminderSettings = getClientReminderSetting(c.id);
    const frequencyDisplay = clientReminderSettings.frequency === 'custom'
      ? `Every ${clientReminderSettings.customDays} days`
      : clientReminderSettings.frequency.charAt(0).toUpperCase() + clientReminderSettings.frequency.slice(1);

    tr.innerHTML = `
      <td><input type="checkbox" class="rowSelect" data-id="${c.id}"></td>
      <td><strong>${escapeHtml(c.name)}</strong></td>
      <td>â‚¹${amountNum.toLocaleString('en-IN')}</td>
      <td>${formatPeriod(c.start, c.end)}</td>
      <td><span class="pill ${status === 'PAID' ? 'paid' : status === 'OVERDUE' ? 'overdue' : 'due'}">${status}</span></td>
      <td>${escapeHtml(c.phone || '-')}</td>
      <td>
        <select onchange="updateClientReminderFrequency('${c.id}', this.value)" class="small" style="font-size:.75rem; padding:.2rem;">
          <option value="monthly" ${clientReminderSettings.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
          <option value="weekly" ${clientReminderSettings.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
          <option value="biweekly" ${clientReminderSettings.frequency === 'biweekly' ? 'selected' : ''}>Bi-weekly</option>
          <option value="custom" ${clientReminderSettings.frequency === 'custom' ? 'selected' : ''}>Custom</option>
        </select>
        ${clientReminderSettings.frequency === 'custom' ?
          `<input type="number" min="1" max="365" value="${clientReminderSettings.customDays}"
            onchange="updateClientCustomDays('${c.id}', this.value)"
            class="small" style="font-size:.75rem; padding:.2rem; width:60px; margin-left:.25rem;" placeholder="days">` :
          ''}
      </td>
      <td class="actions">
        <button onclick="showPaymentHistory('${c.id}')" class="ghost small">
  History
</button>
        <button onclick="sendWA('${c.id}')" aria-label="Send WhatsApp message">WhatsApp</button>
        <button onclick="sendSMS('${c.id}')" class="sms" aria-label="Send SMS">SMS</button>
        <button onclick="showQR('${c.id}')" class="upi" aria-label="Open UPI QR">UPI QR</button>
        <button onclick="sharePaymentLink('${c.id}')" class="upi small" aria-label="Share payment link">Share Link</button>
        <button onclick="shareQrToWhatsAppWithUpload('${c.id}')" class="ghost small" aria-label="Send QR (Direct)">Send QR (Direct)</button>
        <button onclick="showImportantNoteModal('${c.id}')" class="ghost small" aria-label="Important Note">Note</button>
        <button onclick="startEdit('${c.id}')" class="ghost" aria-label="Edit client">Edit</button>
        <button onclick="markPaid('${c.id}', true)" class="${c.paid ? 'red' : 'green'}" aria-label="Toggle paid">${c.paid ? 'Unpaid' : 'Paid'}</button>
        <button onclick="deleteClient('${c.id}')" class="ghost" aria-label="Delete client">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const totalDue = pendingAmt + overdueAmt;
  document.getElementById('totalCount').textContent = `Total Clients: ${clients.length}`;
  document.getElementById('dueCount').textContent = `Pending: ${pendingCount}`;
  document.getElementById('totalDue').textContent = `â‚¹${totalDue.toLocaleString('en-IN')}`;

  // Chart
  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('dueChart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Pending', 'Overdue', 'Paid'],
      datasets: [{ data: [pendingAmt, overdueAmt, paidAmt] }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });

  // Bulk select
  const bulkBtn = document.getElementById('bulkPaidBtn');
  if (bulkBtn) {
    bulkBtn.style.display = visibleClients.length ? 'inline-block' : 'none';
    bulkBtn.onclick = () => {
      const selected = document.querySelectorAll('.rowSelect:checked');
      if (selected.length === 0) return alert('Select clients first');
      selected.forEach(cb => markPaid(cb.dataset.id, true));
      render();
    };
  }
  const selectAll = document.getElementById('selectAll');
  if (selectAll) {
    selectAll.onchange = (e) => {
      document
        .querySelectorAll('#table tbody .rowSelect')
        .forEach(cb => cb.checked = e.target.checked);
    };
  }

  // Extra dashboard metrics (Feature 4)
  const now = new Date();
  const ymKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  let thisMonthBilled = 0;
  let thisMonthPaid = 0;
  let overdueCount = 0;

  clients.forEach(c => {
    const end = String(c.end || '');
    const amt = Number(c.amount || 0);
    if (end === ymKey) {
      thisMonthBilled += amt;
      if (c.paid) thisMonthPaid += amt;
    }
    if (computeStatus(c) === 'OVERDUE') overdueCount++;
  });

  const billedEl = document.getElementById('thisMonthBilled');
  const paidEl = document.getElementById('thisMonthPaid');
  const overdueEl = document.getElementById('overdueCount');
  if (billedEl) billedEl.textContent = `â‚¹${thisMonthBilled.toLocaleString('en-IN')}`;
  if (paidEl) paidEl.textContent = `â‚¹${thisMonthPaid.toLocaleString('en-IN')}`;
  if (overdueEl) overdueEl.textContent = overdueCount.toString();
}

/* ======= Client Portal (Feature 7) ======= */
function showClientPortal() {
  const c = clients.find(x => x.id === CLIENT_MODE_ID);
  const portal = document.getElementById('clientPortalCard');
  const fullTableCard = document.querySelector('table')?.closest('.card');
  const newClientCard = document.getElementById('newClientHeading')?.closest('.card');

  if (!portal) return;

  if (!c) {
    portal.classList.remove('hidden');
    portal.innerHTML = '<p>Client not found. Please contact your accountant.</p>';
    if (fullTableCard) fullTableCard.classList.add('hidden');
    if (newClientCard) newClientCard.classList.add('hidden');
    return;
  }

  if (fullTableCard) fullTableCard.classList.add('hidden');
  if (newClientCard) newClientCard.classList.add('hidden');

  portal.classList.remove('hidden');
  document.getElementById('clientPortalName').textContent = c.name;
  document.getElementById('clientPortalAmount').textContent = 'â‚¹' + Number(c.amount || 0).toLocaleString('en-IN');
  document.getElementById('clientPortalPeriod').textContent = formatPeriod(c.start, c.end);
  document.getElementById('clientPortalStatus').textContent = computeStatus(c);

  document.getElementById('clientPortalPayUpi').onclick = () => {
    const intent = buildUpiIntent(c.amount);
    window.location.href = intent;
  };
  document.getElementById('clientPortalWhatsApp').onclick = () => sendWA(c.id);

  const h1 = document.querySelector('header h1');
  if (h1) h1.textContent = 'J. Bilal & Co. â€¢ Client Portal';
}

/* ======= Messaging functions ======= */
window.sendWA = id => {
  const c = clients.find(x => x.id === id);
  if (!c) return;
  const periodText = formatPeriod(c.start, c.end);
  const upiIntent = buildUpiIntent(c.amount);
  const message =
`Dear ${c.name},

GST Monthly Returns Pending Fees of Rs. ${Number(c.amount).toLocaleString('en-IN')}.00 is payable for the period ${periodText}.

Please settle payment using this link: 

Pay Via Gpay (OR) PhonePe :
${upiIntent}

Thank you,
J. Bilal & Co.
Auditors & Tax Consultants
+91 94425 36488`;

  const encoded = encodeURIComponent(message);
  const phone = (c.phone || '').replace(/[^0-9+]/g, '').replace(/^0+/, '').replace(/^\+/, '');
  const url = phone
    ? `https://wa.me/${phone}?text=${encoded}`
    : `https://wa.me/?text=${encoded}`;
  window.open(url, 'WHATSAPP_WEB_SINGLE_TAB');
};

window.sendSMS = id => {
  const c = clients.find(x => x.id === id);
  if (!c) return;
  const periodText = formatPeriod(c.start, c.end);
  const upiIntent = buildUpiIntent(c.amount);
  const msg = encodeURIComponent(
    `Dear ${c.name}, GST Fees â‚¹${c.amount} pending (${periodText}). Pay using UPI: ${upiIntent} | Bank: ${BANK_ACCOUNT}, IFSC ${BANK_IFSC}. - J. Bilal & Co.`
  );
  const phone = (c.phone || '').replace(/[^0-9+]/g, '');
  window.location.href = `sms:${phone}?body=${msg}`;
};

// Preferred function: native share or imgbb fallback
async function shareQrToWhatsAppWithUpload(id) {
  const c = clients.find(x => x.id === id);
  if (!c) return alert('Client not found');
  const upiLink = buildUpiIntent(c.amount);
  const caption = `Pay GST Fees â‚¹${Number(c.amount).toLocaleString('en-IN')} for ${c.name}.\n\nUPI: ${upiLink}`;
  try {
    const tmp = new QRCodeStyling({
      width: 800, height: 800, data: upiLink, margin: 10,
      dotsOptions: { color: "#000000", type: "rounded" },
      backgroundOptions: { color: "#ffffff" }
    });
    const wrap = document.createElement('div');
    wrap.style.position = 'fixed';
    wrap.style.left = '-9999px';
    document.body.appendChild(wrap);
    tmp.append(wrap);
    const blob = await tmp.getRawData('png');
    const file = new File([blob], `${c.name.replace(/\s+/g,'_')}_qr.png`, { type: 'image/png' });

    // Native share (mobile)
    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      await navigator.share({ files: [file], text: caption, title: `GST Payment â€” ${c.name}` });
      showToast('Share sheet opened â€” choose WhatsApp');
      document.body.removeChild(wrap);
      return;
    }

    // imgbb upload fallback
    if (IMGBB_API_KEY) {
      const fd = new FormData();
      fd.append('key', IMGBB_API_KEY);
      fd.append('image', blob);
      fd.append('name', `${c.name.replace(/\s+/g,'_')}_qr`);
      showToast('Uploading QR image...');
      const resp = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: fd });
      const json = await resp.json();
      if (!json || !json.data || !json.data.display_url) throw new Error('Image upload failed');
      const imageUrl = json.data.display_url;
      const waMsg = encodeURIComponent(`${caption}\n\n${imageUrl}`);
      const phone = (c.phone || '').replace(/[^0-9+]/g, '').replace(/^\+/, '');
      window.open(
        phone ? `https://wa.me/${phone}?text=${waMsg}` : `https://wa.me/?text=${waMsg}`,
        '_blank', 'noopener'
      );
      showToast('WhatsApp opened â€” image link included');
      document.body.removeChild(wrap);
      return;
    }

    // Fallback: download & open WhatsApp with text
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${c.name.replace(/\s+/g,'_')}_qr.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    try {
      await navigator.clipboard.writeText(`${caption}\n(QR downloaded â€” please attach)`);
      showToast('Link copied â€” QR downloaded');
    } catch(e) {}

    const waMsg = encodeURIComponent(`${caption}\n\n(QR downloaded â€” please attach)`);
    const phone = (c.phone || '').replace(/[^0-9+]/g, '').replace(/^\+/, '');
    window.open(
      phone ? `https://wa.me/${phone}?text=${waMsg}` : `https://wa.me/?text=${waMsg}`,
      '_blank', 'noopener'
    );
    document.body.removeChild(wrap);
  } catch (err) {
    console.error('shareQrToWhatsAppWithUpload error', err);
    alert('Could not send QR: ' + (err && err.message ? err.message : err));
  }
}

window.showQR = (id, autoLaunch = false) => {
  const c = clients.find(x => x.id === id);
  if (!c) return;
  const upiLink = buildUpiIntent(c.amount);
  document.getElementById('clientNameDisplay').textContent = c.name;
  document.getElementById('qrAmount').textContent = `â‚¹${Number(c.amount).toLocaleString('en-IN')}`;
  try {
    if (qrInstance && qrInstance._el) qrInstance._el.innerHTML = '';
  } catch(e){}
  qrInstance = new QRCodeStyling({
    width: 340, height: 340, data: upiLink, margin: 10,
    dotsOptions: { color: "#8b5cf6", type: "rounded" },
    backgroundOptions: { color: "#ffffff" }
  });
  const canvasWrapper = document.getElementById('qrCanvas');
  canvasWrapper.innerHTML = '';
  qrInstance.append(canvasWrapper);
  document.getElementById('qrOverlay').classList.remove('hidden');
  showToast();
  const directBtn = document.getElementById('directPayBtn');
  if (directBtn) {
    directBtn.onclick = () => { window.location.href = upiLink; };
  }
  if (autoLaunch) {
    setTimeout(() => window.location.href = upiLink, 500);
  }
};

/* ======= Share payment link (text link) ======= */
window.sharePaymentLink = async (id) => {
  const c = clients.find(x => x.id === id);
  if (!c) return;
  const link = location.origin + location.pathname + '?pay=' + c.id;
  const text = `Pay GST Fees of â‚¹${Number(c.amount).toLocaleString('en-IN')} for ${c.name}.\n${link}`;
  if (navigator.share) {
    try {
      await navigator.share({ title: 'GST Payment', text, url: link });
      showToast('Shared via native share');
      return;
    } catch (e) { /* ignore */ }
  }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    try {
      await navigator.clipboard.writeText(link);
      showToast('Payment link copied');
    } catch (e) {}
  } else {
    prompt('Copy payment link', link);
  }
  const waMsg = encodeURIComponent(`Dear ${c.name}, please pay GST fees: ${link}`);
  const phone = (c.phone || '').replace(/[^0-9+]/g, '').replace(/^\+/, '');
  const waUrl = phone
    ? `https://wa.me/${phone}?text=${waMsg}`
    : `https://wa.me/?text=${waMsg}`;
  window.open(waUrl, '_blank', 'noopener,noreferrer');
};
/* ======= Mark paid / delete ======= */
window.markPaid = (id, bulk = false) => {
  const c = clients.find(x => x.id === id);
  if (!c.paid) {
  c.payments = c.payments || [];
  c.payments.push({
    date: new Date().toISOString(),
    amount: Number(c.amount),
    note: 'Full payment'
  });
}
  c.paid = !c.paid;
  save();
  if (!bulk) showToast('Status updated');
  render();
};

window.deleteClient = (id) => {
  const idx = clients.findIndex(c => c.id === id);
  if (idx === -1) return alert('Client not found');
  if (!confirm(`Delete ${clients[idx].name}? This cannot be undone.`)) return;
  clients.splice(idx, 1);
  save();
  render();
  showToast('Client deleted');
};

/* ======= Form handling ======= */
function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}
function normalizePhone(input) {
  if (!input) return '';
  let p = input.replace(/[^\d+]/g, '').trim();
  if (!p) return '';
  if (p.startsWith('+')) {
    p = '+' + p.slice(1).replace(/\D/g, '');
    return p;
  }
  p = p.replace(/^0+/, '');
  const digits = p.replace(/\D/g, '');
  if (digits.length === 10) return '+91' + digits;
  if (digits.length > 10) return '+' + digits;
  return '+' + digits;
}

document.getElementById('clientForm').addEventListener('submit', (ev) => {
  ev.preventDefault();
  const editingId = document.getElementById('editingId').value;
  const name = document.getElementById('clientName').value.trim();
  const amt = document.getElementById('amount').value;
  const start = document.getElementById('startMonth').value;
  const end = document.getElementById('endMonth').value;
  let phone = document.getElementById('phone').value.trim();

  if (!name || !amt || !start || !end) return alert("Fill all required fields");
  const startNum = Number(start.replace('-', ''));
  const endNum = Number(end.replace('-', ''));
  if (startNum > endNum) return alert("End month must be after or same as start month.");

  phone = normalizePhone(phone) || '';

  if (editingId) {
    const idx = clients.findIndex(c => c.id === editingId);
    if (idx === -1) {
      alert('Client not found');
      cancelEdit();
      return;
    }
    clients[idx].name = name.toUpperCase();
    clients[idx].amount = Number(amt).toFixed(2);
    clients[idx].start = start;
    clients[idx].end = end;
    clients[idx].phone = phone;
    save();
    render();
    showToast('Client updated');
    cancelEdit();
  } else {
    clients.push({
      id: uid(),
      name: name.toUpperCase(),
      amount: Number(amt).toFixed(2),
      start,
      end,
      phone,
      paid: false,
      payments: []
    });
    save();
    render();
    document.getElementById('clientForm').reset();
    showToast('Client added');
  }
});

document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

/* ======= Monthly Reminder Form Handling ======= */
function loadReminderSettings() {
  const settings = getMonthlyReminders();
  document.getElementById('reminderEnabled').checked = settings.enabled;
  document.getElementById('scheduleType').value = settings.scheduleType || 'monthly';
  document.getElementById('reminderDay').value = settings.dayOfMonth;
  document.getElementById('reminderDayOfWeek').value = settings.dayOfWeek || 1;
  document.getElementById('reminderTime').value = settings.sendTime;
  document.getElementById('reminderMessage').value = settings.messageTemplate;

  // Show/hide schedule options based on type
  toggleScheduleOptions();
}

function saveReminderSettings() {
  const scheduleType = document.getElementById('scheduleType').value;
  const settings = {
    enabled: document.getElementById('reminderEnabled').checked,
    scheduleType: scheduleType,
    sendTime: document.getElementById('reminderTime').value,
    messageTemplate: document.getElementById('reminderMessage').value.trim(),
    lastSent: getMonthlyReminders().lastSent
  };

  if (scheduleType === 'monthly') {
    settings.dayOfMonth = parseInt(document.getElementById('reminderDay').value);
  } else {
    settings.dayOfWeek = parseInt(document.getElementById('reminderDayOfWeek').value);
  }

  saveMonthlyReminders(settings);
  showToast('Reminder settings saved');
}

function testMonthlyReminder() {
  const unpaidClients = clients.filter(c => !c.paid);
  if (unpaidClients.length === 0) {
    alert('No unpaid clients to test with');
    return;
  }

  if (!confirm(`This will send test reminders to ${unpaidClients.length} unpaid clients. Continue?`)) {
    return;
  }

  const settings = {
    messageTemplate: document.getElementById('reminderMessage').value.trim()
  };

  sendBulkScheduledReminders(unpaidClients.slice(0, 3), settings); // Test with first 3 clients
  addReminderHistory({
    type: 'test',
    clientCount: Math.min(3, unpaidClients.length),
    message: 'Test reminders sent'
  });
}

function updateClientReminderFrequency(clientId, frequency) {
  const clientSettings = getClientReminderSetting(clientId);
  setClientReminderSetting(clientId, {
    frequency: frequency,
    lastReminderSent: null // Reset last sent when changing frequency
  });
  render(); // Re-render to show updated frequency options
}

function updateClientCustomDays(clientId, days) {
  const daysNum = parseInt(days);
  if (isNaN(daysNum) || daysNum < 1 || daysNum > 365) {
    alert('Please enter a valid number of days (1-365)');
    return;
  }
  setClientReminderSetting(clientId, {
    customDays: daysNum,
    lastReminderSent: null // Reset last sent when changing custom days
  });
}

function toggleScheduleOptions() {
  const scheduleType = document.getElementById('scheduleType').value;
  const monthlyOptions = document.getElementById('monthlyOptions');
  const weeklyOptions = document.getElementById('weeklyOptions');

  if (scheduleType === 'monthly') {
    monthlyOptions.style.display = 'flex';
    weeklyOptions.style.display = 'none';
  } else {
    monthlyOptions.style.display = 'none';
    weeklyOptions.style.display = 'flex';
  }
}

function showReminderHistory() {
  const history = getReminderHistory();
  const historyDiv = document.getElementById('reminderHistory');
  const historyList = document.getElementById('historyList');

  if (history.length === 0) {
    historyDiv.style.display = 'none';
    return;
  }

  historyDiv.style.display = 'block';
  historyList.innerHTML = history.slice(0, 10).map(entry => {
    const date = new Date(entry.timestamp).toLocaleString('en-IN');
    return `<div style="padding:.25rem 0; border-bottom:1px solid rgba(55,65,81,0.3);">
      <strong>${date}</strong> - ${entry.message}
      ${entry.clientCount ? ` (${entry.clientCount} clients)` : ''}
    </div>`;
  }).join('');
}

// Reminder form event listeners
document.getElementById('reminderForm').addEventListener('submit', (e) => {
  e.preventDefault();
  saveReminderSettings();
});

document.getElementById('scheduleType').addEventListener('change', toggleScheduleOptions);

document.getElementById('testReminderBtn').addEventListener('click', testMonthlyReminder);

/* ======= CSV export ======= */
document.getElementById('exportBtn').addEventListener('click', () => {
  if (!clients.length) {
    alert('No clients to export');
    return;
  }
  const csvEscape = (v) => `"${String(v ?? '').replace(/"/g, '""')}"`;
  let csv = "Company,Amount,From,To,Phone,Status\n";
  clients.forEach(c => {
    const status = computeStatus(c);
    csv += [
      csvEscape(c.name),
      c.amount ?? '',
      c.start ?? '',
      c.end ?? '',
      csvEscape(c.phone || ''),
      status
    ].join(',') + "\n";
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'gst-fees-2025.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ======= JSON backup & restore (Feature 5) ======= */
document.getElementById('backupJsonBtn').addEventListener('click', () => {
  const payload = {
    clients,
    upi: getUpiId(),
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'gst-fees-backup.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  showToast('Backup downloaded');
});

document.getElementById('restoreJsonBtn').addEventListener('click', () => {
  const input = document.getElementById('restoreFileInput');
  if (!input) return;
  input.value = '';
  input.click();
});

document.getElementById('restoreFileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (!data || !Array.isArray(data.clients)) {
        alert('Invalid backup file');
        return;
      }
      clients = data.clients;
      save();
      if (data.upi) localStorage.setItem(UPI, data.upi);
      if (CLIENT_MODE_ID) {
        showClientPortal();
      } else {
        render();
      }
      updateMeta();
      showToast('Data restored');
    } catch (err) {
      console.error(err);
      alert('Failed to restore backup');
    }
  };
  reader.readAsText(file);
});

/* ======= Cloud sync buttons ======= */
const syncCloudBtn = document.getElementById('syncCloudBtn');
const loadCloudBtn = document.getElementById('loadCloudBtn');
if (syncCloudBtn) {
  syncCloudBtn.addEventListener('click', syncToCloud);
}
if (loadCloudBtn) {
  loadCloudBtn.addEventListener('click', loadFromCloud);
}

/* ======= Search debounce ======= */
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(render, 180);
});

/* ======= Lock & UPI edit/pay ======= */
document.getElementById('lockBtn').addEventListener('click', () => {
  const app = document.getElementById('app');
  const overlay = document.getElementById('authOverlay');
  if (app) app.style.display = 'none';
  if (overlay) {
    overlay.style.display = 'flex';
    authSetUIForLogin();
  }
});
document.getElementById('editUpi').addEventListener('click', () => {
  const next = prompt("Enter new UPI ID", getUpiId());
  if (next && next.trim()) {
    localStorage.setItem(UPI, next.trim());
    updateMeta();
    alert("UPI ID updated successfully.");
  }
});
document.getElementById('payDirect').addEventListener('click', () => {
  window.location.href = buildUpiIntent('');
});

/* ======= QR upload/clear ======= */
const uploadBtn = document.getElementById('uploadQrBtn');
const uploadInput = document.getElementById('qrUpload');
const clearBtn = document.getElementById('clearQrBtn');
if (uploadBtn && uploadInput) {
  uploadBtn.addEventListener('click', () => uploadInput.click());
  uploadInput.addEventListener('change', e => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      const dataUrl = evt.target.result;
      localStorage.setItem(STATIC_QR_KEY, dataUrl);
      updateStaticQrPreview(dataUrl);
      showToast('QR image updated');
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  });
}
if (clearBtn) {
  clearBtn.addEventListener('click', () => {
    localStorage.removeItem(STATIC_QR_KEY);
    updateStaticQrPreview('');
    showToast('QR image removed');
  });
}

/* ======= Generate static QR buttons ======= */
document.getElementById('genStaticWithAmt').addEventListener('click', async () => {
  const amt = String(document.getElementById('staticAmount').value || '').trim();
  if (!amt || isNaN(Number(amt))) return alert('Enter a valid amount (e.g. 600 or 600.00)');
  const upi = buildUpiIntent(Number(amt).toFixed(2));
  await generateAndSaveStaticQr(upi);
});
document.getElementById('genStaticNoAmt').addEventListener('click', async () => {
  const upi = buildUpiIntent('');
  await generateAndSaveStaticQr(upi);
});

/* ======= Date & meta update ======= */
function updateDate() {
  const options = {
    weekday:'long', year:'numeric', month:'long', day:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  };
  document.getElementById('currentDate').textContent = new Date().toLocaleString('en-IN', options);
}
function startClock() {
  updateDate();
  clearInterval(clockTimer);
  clockTimer = setInterval(() => {
    updateDate();
    checkAndSendScheduledReminders(); // Check for reminders every minute
  }, 60000); // Check every 60 seconds
}
function updateMeta() {
  document.getElementById('upiDisplay').textContent = getUpiId();
  const holder = document.getElementById('accountHolder');
  if (holder) holder.textContent = BANK_ACCOUNT_NAME;
  document.getElementById('bankAccount').textContent = BANK_ACCOUNT;
  document.getElementById('bankIfsc').textContent = BANK_IFSC;
  document.getElementById('phonePrimary').textContent = PHONE_PRIMARY;
  document.getElementById('phoneBackup').textContent = PHONE_BACKUP;
}

/* ======= Password protection ======= */
async function sha256hex(str) {
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2,'0'))
    .join('');
}
function authSetUIForSetup() {
  document.getElementById('authMessage').textContent = 'No password set. Create a new password to secure access.';
  document.getElementById('authSetup').style.display = 'block';
  document.getElementById('authLogin').style.display = 'none';
}
function authSetUIForLogin() {
  document.getElementById('authMessage').textContent = 'Enter password to view client data.';
  document.getElementById('authSetup').style.display = 'none';
  document.getElementById('authLogin').style.display = 'block';
  document.getElementById('loginPass').value = '';
}
function showAppAfterAuth() {
  document.getElementById('authOverlay').style.display = 'none';
  const app = document.getElementById('app');
  if (app) app.style.display = 'block';
  load();
  updateMeta();
  startClock();
  loadStaticQr();
  loadReminderSettings();
  showReminderHistory();
  checkAndSendScheduledReminders(); // Check for due reminders on app load
  if (CLIENT_MODE_ID) {
    showClientPortal();
  } else {
    render();
  }
  // If direct pay link
  if (PAY_ID) {
    const c = clients.find(x => x.id === PAY_ID);
    if (c) {
      document.querySelectorAll('.card, header button').forEach(el => el.style.display = 'none');
      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = "J. Bilal & Co. â€¢ GST Payment";
      showQR(PAY_ID, true);
    }
  }
}
async function setPasswordFlow() {
  const a = document.getElementById('newPass').value || '';
  const b = document.getElementById('confirmPass').value || '';
  if (!a || !b) return alert('Password required');
  if (a !== b) return alert('Passwords do not match');
  const h = await sha256hex(a);
  localStorage.setItem('gst_auth_hash', h);
  alert('Password saved. You can now login.');
  authSetUIForLogin();
}
async function tryLogin() {
  const p = document.getElementById('loginPass').value || '';
  if (!p) return alert('Enter password');
  const stored = localStorage.getItem('gst_auth_hash');
  if (!stored) {
    authSetUIForSetup();
    return;
  }
  const h = await sha256hex(p);
  if (h === stored) {
    showAppAfterAuth();
  } else {
    alert('Incorrect password');
  }
}
function forgotPasswordFlow() {
  const confirmReset = prompt('Type RESET to clear the saved password and set a new one.');
  if (confirmReset === 'RESET') {
    localStorage.removeItem('gst_auth_hash');
    alert('Password cleared. Create a new password now.');
    authSetUIForSetup();
  } else {
    alert('Reset cancelled');
  }
}

/* ======= Broadcast unpaid (WhatsApp / SMS) ======= */
function broadcastUnpaid(type = 'wa', delayMs = 700) {
  const unpaid = clients.filter(c => !c.paid);
  if (!unpaid || unpaid.length === 0) return alert('No unpaid clients found.');
  if (!confirm(`This will open ${unpaid.length} ${type === 'wa' ? 'WhatsApp' : 'SMS'} window(s). Continue?`)) return;
  let i = 0;
  const openNext = () => {
    if (i >= unpaid.length) {
      showToast(`Opened ${unpaid.length} messages`);
      return;
    }
    const c = unpaid[i];
    const periodText = formatPeriod(c.start, c.end);
    if (type === 'wa') {
      const upiIntent = buildUpiIntent(c.amount);
      const message =
`Dear ${c.name},

GST Returns Pending Fees of Rs. ${Number(c.amount).toLocaleString('en-IN')}.00 is payable for the period ${periodText}.

Pay using UPI:
${upiIntent}

Thank you,
J. Bilal & Co.
+91 94860 24162`;
      const encoded = encodeURIComponent(message);
      const phone = (c.phone || '').replace(/[^0-9+]/g, '').replace(/^0+/, '').replace(/^\+/, '');
      const url = phone
        ? `https://wa.me/${phone}?text=${encoded}`
        : `https://wa.me/?text=${encoded}`;
      window.open(url, 'whatsapp_web');

      i++;
      setTimeout(openNext, delayMs);
    } else {
      const upiIntent = buildUpiIntent(c.amount);
      const smsBody = encodeURIComponent(
        `Dear ${c.name}, GST Fees â‚¹${c.amount} pending (${periodText}). Pay via UPI: ${upiIntent} | Bank: ${BANK_ACCOUNT}, IFSC ${BANK_IFSC}. - J. Bilal & Co.`
      );
      const phone = (c.phone || '').replace(/[^0-9+]/g, '');
      window.location.href = `sms:${phone}?body=${smsBody}`;
      i++;
      setTimeout(openNext, delayMs);
    }
  };
  openNext();
}

/* ======= Bulk Message Template Feature ======= */
function showBulkMessageModal() {
  const unpaid = clients.filter(c => !c.paid);
  if (!unpaid || unpaid.length === 0) {
    alert('No unpaid clients found.');
    return;
  }

  document.getElementById('bulkMessageOverlay').classList.remove('hidden');
  document.getElementById('bulkMessagePreview').style.display = 'none';
}

function previewBulkMessage() {
  const template = document.getElementById('bulkMessageTemplate').value.trim();
  if (!template) {
    alert('Please enter a message template');
    return;
  }

  const unpaid = clients.filter(c => !c.paid);
  if (unpaid.length === 0) return;

  // Use first client for preview
  const firstClient = unpaid[0];
  const previewMessage = buildMessageFromTemplate(template, firstClient);

  document.getElementById('previewContent').textContent = previewMessage;
  document.getElementById('bulkMessagePreview').style.display = 'block';
}

function buildMessageFromTemplate(template, client) {
  const periodText = formatPeriod(client.start, client.end);
  const upiIntent = buildUpiIntent(client.amount);

  return template
    .replace(/{name}/g, client.name)
    .replace(/{amount}/g, Number(client.amount).toLocaleString('en-IN'))
    .replace(/{period}/g, periodText)
    .replace(/{upi}/g, upiIntent);
}

function sendBulkMessage(type = 'whatsapp') {
  const template = document.getElementById('bulkMessageTemplate').value.trim();
  if (!template) {
    alert('Please enter a message template');
    return;
  }

  const unpaid = clients.filter(c => !c.paid);
  if (!unpaid || unpaid.length === 0) return;

  const confirmMessage = type === 'whatsapp'
    ? `This will open ${unpaid.length} WhatsApp windows. Continue?`
    : `This will send ${unpaid.length} SMS messages. Continue?`;

  if (!confirm(confirmMessage)) return;

  let sentCount = 0;
  const delay = 1000; // 1 second delay between messages

  unpaid.forEach((client, index) => {
    setTimeout(() => {
      const message = buildMessageFromTemplate(template, client);

      if (type === 'whatsapp') {
        const encoded = encodeURIComponent(message);
        const phone = (client.phone || '').replace(/[^0-9+]/g, '').replace(/^0+/, '').replace(/^\+/, '');
        const url = phone
          ? `https://wa.me/${phone}?text=${encoded}`
          : `https://wa.me/?text=${encoded}`;
        window.open(url, 'whatsapp_web');
      } else if (type === 'sms') {
        const smsBody = encodeURIComponent(message);
        const phone = (client.phone || '').replace(/[^0-9+]/g, '');
        window.location.href = `sms:${phone}?body=${smsBody}`;
      }

      sentCount++;
      if (index === unpaid.length - 1) {
        showToast(`Opened ${sentCount} ${type === 'whatsapp' ? 'WhatsApp' : 'SMS'} messages`);
        document.getElementById('bulkMessageOverlay').classList.add('hidden');
      }
    }, index * delay);
  });
}

// Make functions available globally for onclick handlers
window.updateClientReminderFrequency = updateClientReminderFrequency;
window.updateClientCustomDays = updateClientCustomDays;

/* ======= Important Note (per-client, typing-only) ======= */
let currentImportantClientId = null;
function importantNoteKeyFor(id) { return `gst_important_note_${id}`; }
function showImportantNoteModal(clientId) {
  const client = clients.find(c => c.id === clientId);
  if (!client) return alert('Client not found');
  currentImportantClientId = clientId;
  document.getElementById('importantNoteClientName').textContent = client.name;
  document.getElementById('importantNoteClientPeriod').textContent = formatPeriod(client.start, client.end);
  const stored = localStorage.getItem(importantNoteKeyFor(clientId)) || '';
  document.getElementById('importantNoteTextarea').value = stored;
  const ts = localStorage.getItem(importantNoteKeyFor(clientId) + '_ts') || null;
  document.getElementById('importantNoteMeta').textContent = ts ? ('Last saved: ' + new Date(ts).toLocaleString()) : 'No saved note yet.';
  document.getElementById('importantNoteOverlay').style.display = 'flex';
}
function closeImportantNoteModal() {
  currentImportantClientId = null;
  document.getElementById('importantNoteOverlay').style.display = 'none';
}
function saveImportantNote() {
  if (!currentImportantClientId) return;
  const txt = document.getElementById('importantNoteTextarea').value;
  localStorage.setItem(importantNoteKeyFor(currentImportantClientId), txt);
  localStorage.setItem(importantNoteKeyFor(currentImportantClientId) + '_ts', new Date().toISOString());
  showToast('Note saved');
  closeImportantNoteModal();
}
function clearImportantNote() {
  if (!currentImportantClientId) return;
  if (!confirm('Clear the important note for this client?')) return;
  localStorage.removeItem(importantNoteKeyFor(currentImportantClientId));
  localStorage.removeItem(importantNoteKeyFor(currentImportantClientId) + '_ts');
  document.getElementById('importantNoteTextarea').value = '';
  document.getElementById('importantNoteMeta').textContent = 'No saved note yet.';
  showToast('Note cleared');
}
document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'closeImportantNoteBtn') closeImportantNoteModal();
  if (e.target && e.target.id === 'saveImportantNoteBtn') saveImportantNote();
  if (e.target && e.target.id === 'clearImportantNoteBtn') clearImportantNote();
});

/* ======= Init ======= */
document.addEventListener('DOMContentLoaded', () => {
  // Broadcast buttons
  const msgBtn = document.getElementById('messageAllBtn');
  const smsBtn = document.getElementById('smsAllBtn');
  if (msgBtn) msgBtn.addEventListener('click', () => broadcastUnpaid('wa', 700));
  if (smsBtn) {
    smsBtn.addEventListener('click', () => {
      if (!confirm('SMS broadcast may move you away from this page. Continue?')) return;
      broadcastUnpaid('sms', 700);
    });
  }

  // Bulk Message Template buttons
  const bulkMessageBtn = document.getElementById('bulkMessageBtn');
  if (bulkMessageBtn) {
    bulkMessageBtn.addEventListener('click', showBulkMessageModal);
  }
  document.getElementById('closeBulkMessageModal').addEventListener('click', () => {
    document.getElementById('bulkMessageOverlay').classList.add('hidden');
  });
  document.getElementById('previewBulkMessage').addEventListener('click', previewBulkMessage);
  document.getElementById('sendBulkMessageWhatsApp').addEventListener('click', () => sendBulkMessage('whatsapp'));
  document.getElementById('sendBulkMessageSMS').addEventListener('click', () => sendBulkMessage('sms'));

  // Auth buttons
  document.getElementById('setPassBtn').addEventListener('click', () => setPasswordFlow());
  document.getElementById('loginBtn').addEventListener('click', () => tryLogin());
  document.getElementById('forgotBtn').addEventListener('click', () => forgotPasswordFlow());
  document.getElementById('closeModal').addEventListener('click', () => document.getElementById('qrOverlay').classList.add('hidden'));

  // Initial auth state
  const stored = localStorage.getItem('gst_auth_hash');
  const overlay = document.getElementById('authOverlay');
  if (!stored) {
    if (overlay) overlay.style.display = 'flex';
    authSetUIForSetup();
  } else {
    if (overlay) overlay.style.display = 'flex';
    authSetUIForLogin();
  }
});

// ===== PWA service worker registration (Feature 10) =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(err => {
      console.log('SW registration failed', err);
    });
  });
}
window.showPaymentHistory = (id) => {
  const c = clients.find(x => x.id === id);
  if (!c || !c.payments || c.payments.length === 0) {
    alert('No payment history available');
    return;
  }

  let text = `Payment History - ${c.name}\n\n`;
  c.payments.forEach((p, i) => {
    text += `${i + 1}. â‚¹${p.amount} | ${new Date(p.date).toLocaleDateString('en-IN')} | ${p.note}\n`;
  });

  alert(text);
};
  </script>
</body>
</html>
